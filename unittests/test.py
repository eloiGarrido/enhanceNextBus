#!/usr/bin/env python3
import tornado.platform.asyncio as tasyncio
import configparser
import logging
import os
import unittest
import sys
from tornado.testing import AsyncHTTPSTestCase, gen_test
import ast

sys.path.insert(0, os.path.dirname('/home/eloig/dev/enhanceNextBus/handlers'))
sys.path.insert(0, os.path.dirname(__file__))
import handlers.base

logger = logging.getLogger('nextBus')

config = configparser.ConfigParser()
config.read('testing.config')

if __name__ == '__name__':
    logging.basicConfig(filename='testing.log',
                        format='%(asctime)s %(message)s',
                        datefmt='%d-%m-%Y %H:%M:%S',
                        level=logging.DEBUG)

    unittest.main()


class TestBaseApp(AsyncHTTPSTestCase):
    def get_app(self):
        return handlers.base.make_app()

    def get_new_ioloop(self):
        return tasyncio.AsyncIOMainLoop()

    @gen_test
    def test_homepage(self):
        res = yield self.http_client.fetch(self.get_url('/'))
        self.assertEqual(res.body, b'Welcome to nextBus Enhanced.\n<br>\nRequest information with the following query '
                                   b'structure:\n<br>\n<br>http://localhost:8888/publicJSONFeed?command=commandName&a='
                                   b'agencyTag&additionParams..')

    @gen_test
    def test_query_counter_handler(self):
        res1 = yield self.http_client.fetch(self.get_url('/queryCounter'))
        res1_format = str(res1.body, 'utf-8')
        dict_res1 = ast.literal_eval(res1_format)
        self.assertEqual(dict_res1, {"agencyList": 1, "routeConfig": 1})

        query = yield self.http_client.fetch(self.get_url('/publicJSONFeed?command=agencyList'))
        res2 = yield self.http_client.fetch(self.get_url('/queryCounter'))
        res2_format = str(res2.body, 'utf-8')
        dict_res2 = ast.literal_eval(res2_format)
        self.assertDictEqual(dict_res2, {"routeConfig": 1, "agencyList": 2})

    @gen_test
    def test_message_handler_route_config(self):
        res = yield self.http_client.fetch(self.get_url('/publicJSONFeed?command=routeConfig&a=sf-muni&r=N'))
        self.assertEqual(res.body, b'{"body": {"@copyright": "All data copyright San Francisco Muni 2017.", "route": {"@tag": "N", "@title": "N-Judah", "@color": "003399", "@oppositeColor": "ffffff", "@latMin": "37.7602999", "@latMax": "37.7932299", "@lonMin": "-122.50868", "@lonMax": "-122.38798", "stop": [{"@tag": "7859", "@title": "Duboce Ave & Church St Ada Only", "@lat": "37.7694599", "@lon": "-122.42912", "@stopId": "17859"}, {"@tag": "4447", "@title": "Duboce Ave & Church St", "@lat": "37.7694699", "@lon": "-122.42941", "@stopId": "14447"}, {"@tag": "7252", "@title": "Sunset Tunnel East Portal", "@lat": "37.7693899", "@lon": "-122.43369", "@stopId": "17252"}, {"@tag": "3909", "@title": "Carl St & Cole St", "@lat": "37.76586", "@lon": "-122.4497999", "@stopId": "13909"}, {"@tag": "3914", "@title": "Carl St & Stanyan St", "@lat": "37.7654999", "@lon": "-122.45259", "@stopId": "13914"}, {"@tag": "3912", "@title": "Carl St & Hillway Ave", "@lat": "37.7649999", "@lon": "-122.45656", "@stopId": "13912"}, {"@tag": "5118", "@title": "Irving St & 2nd Ave", "@lat": "37.7644399", "@lon": "-122.45864", "@stopId": "15118"}, {"@tag": "5119", "@title": "Irving St & 4th Ave", "@lat": "37.7642999", "@lon": "-122.46082", "@stopId": "15119"}, {"@tag": "5121", "@title": "Irving St & 7th Ave", "@lat": "37.7641599", "@lon": "-122.46403", "@stopId": "15121"}, {"@tag": "5123", "@title": "Irving St & 9th Ave", "@lat": "37.76411", "@lon": "-122.4661599", "@stopId": "15123"}, {"@tag": "5193", "@title": "Judah St & 9th Ave", "@lat": "37.7622299", "@lon": "-122.46669", "@stopId": "15193"}, {"@tag": "5195", "@title": "Judah St & 12th Ave", "@lat": "37.76207", "@lon": "-122.46932", "@stopId": "15195"}, {"@tag": "5219", "@title": "Judah St & Funston Ave", "@lat": "37.7620799", "@lon": "-122.4703299", "@stopId": "15219"}, {"@tag": "5198", "@title": "Judah St & 16th Ave", "@lat": "37.76191", "@lon": "-122.4737799", "@stopId": "15198"}, {"@tag": "5199", "@title": "Judah St & 19th Ave", "@lat": "37.7617399", "@lon": "-122.47692", "@stopId": "15199"}, {"@tag": "5202", "@title": "Judah St & 23rd Ave", "@lat": "37.76155", "@lon": "-122.4811599", "@stopId": "15202"}, {"@tag": "5203", "@title": "Judah St & 25th Ave", "@lat": "37.7614499", "@lon": "-122.4833", "@stopId": "15203"}, {"@tag": "5205", "@title": "Judah St & 28th Ave", "@lat": "37.7613099", "@lon": "-122.48651", "@stopId": "15205"}, {"@tag": "5207", "@title": "Judah St & 31st Ave", "@lat": "37.7611699", "@lon": "-122.48972", "@stopId": "15207"}, {"@tag": "5209", "@title": "Judah St & 34th Ave", "@lat": "37.76103", "@lon": "-122.4929299", "@stopId": "15209"}, {"@tag": "5224", "@title": "Judah St & Sunset Blvd", "@lat": "37.7609199", "@lon": "-122.49567", "@stopId": "15224"}, {"@tag": "5211", "@title": "Judah St & 40th Ave", "@lat": "37.76074", "@lon": "-122.4993599", "@stopId": "15211"}, {"@tag": "5213", "@title": "Judah St & 43rd Ave", "@lat": "37.7606", "@lon": "-122.5025699", "@stopId": "15213"}, {"@tag": "5215", "@title": "Judah St & 46th Ave", "@lat": "37.7604899", "@lon": "-122.50583", "@stopId": "15215"}, {"@tag": "7219", "@title": "Judah St & La Playa St", "@lat": "37.7603499", "@lon": "-122.50868", "@stopId": "17219"}, {"@tag": "5241", "@title": "King St & 6th St", "@lat": "37.7733199", "@lon": "-122.39777", "@stopId": "15241"}, {"@tag": "5240", "@title": "King St & 4th St", "@lat": "37.7762699", "@lon": "-122.39408", "@stopId": "15240"}, {"@tag": "5237", "@title": "King St & 2nd St", "@lat": "37.7796199", "@lon": "-122.38982", "@stopId": "15237"}, {"@tag": "7145", "@title": "The Embarcadero & Brannan St", "@lat": "37.7846299", "@lon": "-122.38798", "@stopId": "17145"}, {"@tag": "4510", "@title": "Embarcadero Folsom St", "@lat": "37.7907499", "@lon": "-122.38984", "@stopId": "14510"}, {"@tag": "7217", "@title": "Embarcadero Station Outbound", "@lat": "37.7932299", "@lon": "-122.39654", "@stopId": "17217"}, {"@tag": "6994", "@title": "Montgomery Station Outbound", "@lat": "37.78879", "@lon": "-122.4021299", "@stopId": "16994"}, {"@tag": "6995", "@title": "Powell Station Outbound", "@lat": "37.7843", "@lon": "-122.4078199", "@stopId": "16995"}, {"@tag": "6997", "@title": "Civic Center Station Outbound", "@lat": "37.7786799", "@lon": "-122.41499", "@stopId": "16997"}, {"@tag": "6996", "@title": "Van Ness Station OB", "@lat": "37.7752299", "@lon": "-122.41934", "@stopId": "16996"}, {"@tag": "5223", "@title": "Judah St & La Playa St", "@lat": "37.7602999", "@lon": "-122.50818", "@stopId": "15223"}, {"@tag": "5216", "@title": "Judah St & 46th Ave", "@lat": "37.7603899", "@lon": "-122.50606", "@stopId": "15216"}, {"@tag": "5214", "@title": "Judah St & 43rd Ave", "@lat": "37.7605199", "@lon": "-122.50284", "@stopId": "15214"}, {"@tag": "5212", "@title": "Judah St & 40th Ave", "@lat": "37.76068", "@lon": "-122.4991499", "@stopId": "15212"}, {"@tag": "5225", "@title": "Judah St & Sunset Blvd", "@lat": "37.7608499", "@lon": "-122.4958", "@stopId": "15225"}, {"@tag": "5210", "@title": "Judah St & 34th Ave", "@lat": "37.7609599", "@lon": "-122.4932", "@stopId": "15210"}, {"@tag": "5208", "@title": "Judah St & 31st Ave", "@lat": "37.7611099", "@lon": "-122.4895", "@stopId": "15208"}, {"@tag": "5206", "@title": "Judah St & 28th Ave", "@lat": "37.76123", "@lon": "-122.4867599", "@stopId": "15206"}, {"@tag": "5204", "@title": "Judah St & 25th Ave", "@lat": "37.76137", "@lon": "-122.4835599", "@stopId": "15204"}, {"@tag": "5201", "@title": "Judah St & 22nd Ave", "@lat": "37.7615299", "@lon": "-122.47985", "@stopId": "15201"}, {"@tag": "5200", "@title": "Judah St & 19th Ave", "@lat": "37.7616599", "@lon": "-122.47719", "@stopId": "15200"}, {"@tag": "5197", "@title": "Judah St & 15th Ave", "@lat": "37.7618499", "@lon": "-122.47278", "@stopId": "15197"}, {"@tag": "5220", "@title": "Judah St & Funston Ave", "@lat": "37.76195", "@lon": "-122.4705699", "@stopId": "15220"}, {"@tag": "5196", "@title": "Judah St & 12th Ave", "@lat": "37.76199", "@lon": "-122.4695299", "@stopId": "15196"}, {"@tag": "5194", "@title": "Judah St & 9th Ave", "@lat": "37.7621399", "@lon": "-122.46631", "@stopId": "15194"}, {"@tag": "3212", "@title": "9th Ave & Irving St", "@lat": "37.76391", "@lon": "-122.46624", "@stopId": "13212"}, {"@tag": "5122", "@title": "Irving St & 7th Ave", "@lat": "37.7640899", "@lon": "-122.46428", "@stopId": "15122"}, {"@tag": "5120", "@title": "Irving St & 4th Ave", "@lat": "37.76423", "@lon": "-122.4610599", "@stopId": "15120"}, {"@tag": "5124", "@title": "Irving St & Arguello Blvd", "@lat": "37.76437", "@lon": "-122.4580199", "@stopId": "15124"}, {"@tag": "3913", "@title": "Carl St & Hillway Ave", "@lat": "37.7649299", "@lon": "-122.45651", "@stopId": "13913"}, {"@tag": "3915", "@title": "Carl St & Stanyan St", "@lat": "37.7653699", "@lon": "-122.45293", "@stopId": "13915"}, {"@tag": "3911", "@title": "Carl St & Cole St", "@lat": "37.7657499", "@lon": "-122.45013", "@stopId": "13911"}, {"@tag": "7318", "@title": "Sunset Tunnel East Portal", "@lat": "37.76913", "@lon": "-122.4330799", "@stopId": "17318"}, {"@tag": "4448", "@title": "Duboce Ave & Church St", "@lat": "37.7694099", "@lon": "-122.4294", "@stopId": "14448"}, {"@tag": "5419", "@title": "Van Ness Station Inbound", "@lat": "37.7751299", "@lon": "-122.41925", "@stopId": "15419"}, {"@tag": "5727", "@title": "Civic Center Station Inbound", "@lat": "37.7785399", "@lon": "-122.41481", "@stopId": "15727"}, {"@tag": "5417", "@title": "Powell Station Inbound", "@lat": "37.7841999", "@lon": "-122.40769", "@stopId": "15417"}, {"@tag": "5731", "@title": "Montgomery Station Inbound", "@lat": "37.7886999", "@lon": "-122.40192", "@stopId": "15731"}, {"@tag": "6992", "@title": "Embarcadero Station Inbound", "@lat": "37.7931299", "@lon": "-122.39643", "@stopId": "16992"}, {"@tag": "4509", "@title": "The Embarcadero & Folsom St", "@lat": "37.7904799", "@lon": "-122.38969", "@stopId": "14509"}, {"@tag": "4506", "@title": "The Embarcadero & Brannan St", "@lat": "37.7843599", "@lon": "-122.38814", "@stopId": "14506"}, {"@tag": "5234", "@title": "King St & 2nd St", "@lat": "37.7797199", "@lon": "-122.38987", "@stopId": "15234"}, {"@tag": "5239", "@title": "King St & 4th St", "@lat": "37.7762699", "@lon": "-122.39417", "@stopId": "15239"}, {"@tag": "35241", "@title": "King St & 6th St", "@lat": "37.7733199", "@lon": "-122.39777", "@stopId": "135241"}], "direction": [{"@tag": "N____I_F00", "@title": "Inbound to Caltrain/Ball Park", "@name": "Inbound", "@useForUI": "true", "stop": [{"@tag": "5223"}, {"@tag": "5216"}, {"@tag": "5214"}, {"@tag": "5212"}, {"@tag": "5225"}, {"@tag": "5210"}, {"@tag": "5208"}, {"@tag": "5206"}, {"@tag": "5204"}, {"@tag": "5201"}, {"@tag": "5200"}, {"@tag": "5197"}, {"@tag": "5220"}, {"@tag": "5196"}, {"@tag": "5194"}, {"@tag": "3212"}, {"@tag": "5122"}, {"@tag": "5120"}, {"@tag": "5124"}, {"@tag": "3913"}, {"@tag": "3915"}, {"@tag": "3911"}, {"@tag": "7318"}, {"@tag": "4448"}, {"@tag": "5419"}, {"@tag": "5727"}, {"@tag": "5417"}, {"@tag": "5731"}, {"@tag": "6992"}, {"@tag": "4509"}, {"@tag": "4506"}, {"@tag": "5234"}, {"@tag": "5239"}, {"@tag": "35241"}]}, {"@tag": "N____O_F00", "@title": "Outbound to Ocean Beach", "@name": "Outbound", "@useForUI": "true", "stop": [{"@tag": "5241"}, {"@tag": "5240"}, {"@tag": "5237"}, {"@tag": "7145"}, {"@tag": "4510"}, {"@tag": "7217"}, {"@tag": "6994"}, {"@tag": "6995"}, {"@tag": "6997"}, {"@tag": "6996"}, {"@tag": "7859"}, {"@tag": "4447"}, {"@tag": "7252"}, {"@tag": "3909"}, {"@tag": "3914"}, {"@tag": "3912"}, {"@tag": "5118"}, {"@tag": "5119"}, {"@tag": "5121"}, {"@tag": "5123"}, {"@tag": "5193"}, {"@tag": "5195"}, {"@tag": "5219"}, {"@tag": "5198"}, {"@tag": "5199"}, {"@tag": "5202"}, {"@tag": "5203"}, {"@tag": "5205"}, {"@tag": "5207"}, {"@tag": "5209"}, {"@tag": "5224"}, {"@tag": "5211"}, {"@tag": "5213"}, {"@tag": "5215"}, {"@tag": "7219"}]}], "path": [{"point": [{"@lat": "37.79048", "@lon": "-122.38969"}, {"@lat": "37.78958", "@lon": "-122.38849"}, {"@lat": "37.78931", "@lon": "-122.38827"}, {"@lat": "37.78902", "@lon": "-122.38812"}, {"@lat": "37.78792", "@lon": "-122.38783"}, {"@lat": "37.78149", "@lon": "-122.38832"}, {"@lat": "37.78125", "@lon": "-122.38836"}, {"@lat": "37.78089", "@lon": "-122.38849"}, {"@lat": "37.7804", "@lon": "-122.38889"}, {"@lat": "37.7762699", "@lon": "-122.39417"}]}, {"point": [{"@lat": "37.76174", "@lon": "-122.47692"}, {"@lat": "37.76155", "@lon": "-122.48116"}, {"@lat": "37.76145", "@lon": "-122.4833"}, {"@lat": "37.76131", "@lon": "-122.48651"}, {"@lat": "37.76117", "@lon": "-122.48972"}, {"@lat": "37.76103", "@lon": "-122.49293"}, {"@lat": "37.76092", "@lon": "-122.49567"}]}, {"point": [{"@lat": "37.76941", "@lon": "-122.4294"}, {"@lat": "37.76954", "@lon": "-122.4267"}, {"@lat": "37.76961", "@lon": "-122.42632"}, {"@lat": "37.77513", "@lon": "-122.41925"}]}, {"point": [{"@lat": "37.76493", "@lon": "-122.45651"}, {"@lat": "37.76537", "@lon": "-122.45293"}, {"@lat": "37.76575", "@lon": "-122.45013"}, {"@lat": "37.76589", "@lon": "-122.44952"}, {"@lat": "37.76631", "@lon": "-122.44905"}, {"@lat": "37.76644", "@lon": "-122.44868"}, {"@lat": "37.76927", "@lon": "-122.43461"}, {"@lat": "37.76932", "@lon": "-122.4334"}, {"@lat": "37.7691299", "@lon": "-122.43308"}, {"@lat": "37.76922", "@lon": "-122.43302"}, {"@lat": "37.76941", "@lon": "-122.4294"}]}, {"point": [{"@lat": "37.7762699", "@lon": "-122.39417"}, {"@lat": "37.77373", "@lon": "-122.39736"}, {"@lat": "37.7735399", "@lon": "-122.39753"}, {"@lat": "37.77332", "@lon": "-122.39777"}]}, {"point": [{"@lat": "37.79048", "@lon": "-122.38969"}, {"@lat": "37.78958", "@lon": "-122.38849"}, {"@lat": "37.78931", "@lon": "-122.38827"}, {"@lat": "37.78902", "@lon": "-122.38812"}, {"@lat": "37.78792", "@lon": "-122.38783"}, {"@lat": "37.78436", "@lon": "-122.38814"}, {"@lat": "37.78149", "@lon": "-122.38832"}, {"@lat": "37.78125", "@lon": "-122.38836"}, {"@lat": "37.78089", "@lon": "-122.38849"}, {"@lat": "37.7804", "@lon": "-122.38889"}, {"@lat": "37.77972", "@lon": "-122.38987"}, {"@lat": "37.77634", "@lon": "-122.39405"}, {"@lat": "37.7762699", "@lon": "-122.39417"}]}, {"point": [{"@lat": "37.76166", "@lon": "-122.47719"}, {"@lat": "37.76185", "@lon": "-122.47278"}, {"@lat": "37.76195", "@lon": "-122.47057"}, {"@lat": "37.76199", "@lon": "-122.46953"}, {"@lat": "37.76214", "@lon": "-122.46631"}, {"@lat": "37.76218", "@lon": "-122.46619"}, {"@lat": "37.76391", "@lon": "-122.46624"}, {"@lat": "37.76404", "@lon": "-122.46632"}, {"@lat": "37.76409", "@lon": "-122.46428"}, {"@lat": "37.76423", "@lon": "-122.46106"}, {"@lat": "37.76437", "@lon": "-122.45802"}, {"@lat": "37.76441", "@lon": "-122.45783"}, {"@lat": "37.76482", "@lon": "-122.45773"}, {"@lat": "37.76493", "@lon": "-122.45651"}]}, {"point": [{"@lat": "37.76946", "@lon": "-122.42912"}, {"@lat": "37.76947", "@lon": "-122.42941"}, {"@lat": "37.76922", "@lon": "-122.43301"}, {"@lat": "37.76932", "@lon": "-122.43341"}, {"@lat": "37.76939", "@lon": "-122.43369"}, {"@lat": "37.76927", "@lon": "-122.43461"}, {"@lat": "37.76644", "@lon": "-122.44868"}, {"@lat": "37.7663", "@lon": "-122.44905"}, {"@lat": "37.76599", "@lon": "-122.44938"}, {"@lat": "37.76586", "@lon": "-122.4498"}, {"@lat": "37.76581", "@lon": "-122.44997"}, {"@lat": "37.76562", "@lon": "-122.45141"}, {"@lat": "37.7655", "@lon": "-122.45259"}, {"@lat": "37.765", "@lon": "-122.45656"}]}, {"point": [{"@lat": "37.77513", "@lon": "-122.41925"}, {"@lat": "37.77854", "@lon": "-122.41481"}, {"@lat": "37.7842", "@lon": "-122.40769"}, {"@lat": "37.7887", "@lon": "-122.40192"}, {"@lat": "37.79313", "@lon": "-122.39643"}]}, {"point": [{"@lat": "37.79323", "@lon": "-122.39654"}, {"@lat": "37.78879", "@lon": "-122.40213"}, {"@lat": "37.7843", "@lon": "-122.40782"}, {"@lat": "37.77868", "@lon": "-122.41499"}, {"@lat": "37.77523", "@lon": "-122.41934"}]}, {"point": [{"@lat": "37.77332", "@lon": "-122.39777"}, {"@lat": "37.7735399", "@lon": "-122.39753"}, {"@lat": "37.77373", "@lon": "-122.39736"}, {"@lat": "37.7745", "@lon": "-122.39639"}, {"@lat": "37.7762699", "@lon": "-122.39408"}]}, {"point": [{"@lat": "37.76092", "@lon": "-122.49567"}, {"@lat": "37.76074", "@lon": "-122.49936"}, {"@lat": "37.7605999", "@lon": "-122.50257"}, {"@lat": "37.76049", "@lon": "-122.50583"}, {"@lat": "37.76033", "@lon": "-122.50808"}, {"@lat": "37.76035", "@lon": "-122.50868"}]}, {"point": [{"@lat": "37.765", "@lon": "-122.45656"}, {"@lat": "37.76482", "@lon": "-122.45773"}, {"@lat": "37.76455", "@lon": "-122.45771"}, {"@lat": "37.76444", "@lon": "-122.45864"}, {"@lat": "37.76437", "@lon": "-122.45883"}, {"@lat": "37.7643", "@lon": "-122.46082"}, {"@lat": "37.7641599", "@lon": "-122.46403"}, {"@lat": "37.76411", "@lon": "-122.46616"}, {"@lat": "37.76404", "@lon": "-122.46632"}, {"@lat": "37.76218", "@lon": "-122.46619"}, {"@lat": "37.76223", "@lon": "-122.46669"}, {"@lat": "37.76207", "@lon": "-122.46932"}, {"@lat": "37.76208", "@lon": "-122.47033"}, {"@lat": "37.76191", "@lon": "-122.47378"}, {"@lat": "37.76174", "@lon": "-122.47692"}]}, {"point": [{"@lat": "37.79075", "@lon": "-122.38984"}, {"@lat": "37.7911", "@lon": "-122.39032"}, {"@lat": "37.79159", "@lon": "-122.39071"}, {"@lat": "37.7920299", "@lon": "-122.39084"}, {"@lat": "37.7927899", "@lon": "-122.39126"}, {"@lat": "37.79303", "@lon": "-122.39145"}, {"@lat": "37.7942899", "@lon": "-122.3929"}, {"@lat": "37.79445", "@lon": "-122.39317"}, {"@lat": "37.7947", "@lon": "-122.39379"}, {"@lat": "37.79477", "@lon": "-122.39419"}, {"@lat": "37.79475", "@lon": "-122.39454"}, {"@lat": "37.79323", "@lon": "-122.39654"}]}, {"point": [{"@lat": "37.7603", "@lon": "-122.50818"}, {"@lat": "37.76039", "@lon": "-122.50606"}, {"@lat": "37.76052", "@lon": "-122.50284"}, {"@lat": "37.76068", "@lon": "-122.49915"}, {"@lat": "37.76085", "@lon": "-122.4958"}]}, {"point": [{"@lat": "37.76085", "@lon": "-122.4958"}, {"@lat": "37.76096", "@lon": "-122.4932"}, {"@lat": "37.76111", "@lon": "-122.4895"}, {"@lat": "37.76123", "@lon": "-122.48676"}, {"@lat": "37.76137", "@lon": "-122.48356"}, {"@lat": "37.76153", "@lon": "-122.47985"}, {"@lat": "37.76166", "@lon": "-122.47719"}]}, {"point": [{"@lat": "37.79075", "@lon": "-122.38984"}, {"@lat": "37.79159", "@lon": "-122.39071"}, {"@lat": "37.7920299", "@lon": "-122.39084"}, {"@lat": "37.7927899", "@lon": "-122.39126"}, {"@lat": "37.79303", "@lon": "-122.39145"}, {"@lat": "37.7942899", "@lon": "-122.3929"}, {"@lat": "37.79445", "@lon": "-122.39317"}, {"@lat": "37.7947", "@lon": "-122.39379"}, {"@lat": "37.79477", "@lon": "-122.39419"}, {"@lat": "37.79475", "@lon": "-122.39454"}, {"@lat": "37.79323", "@lon": "-122.39654"}]}, {"point": [{"@lat": "37.77523", "@lon": "-122.41934"}, {"@lat": "37.76961", "@lon": "-122.42632"}, {"@lat": "37.76954", "@lon": "-122.4267"}, {"@lat": "37.7694", "@lon": "-122.429"}, {"@lat": "37.76946", "@lon": "-122.42912"}]}, {"point": [{"@lat": "37.79048", "@lon": "-122.38969"}, {"@lat": "37.78958", "@lon": "-122.38849"}, {"@lat": "37.78931", "@lon": "-122.38827"}, {"@lat": "37.78902", "@lon": "-122.38812"}, {"@lat": "37.78792", "@lon": "-122.38783"}, {"@lat": "37.78436", "@lon": "-122.38814"}, {"@lat": "37.78149", "@lon": "-122.38832"}, {"@lat": "37.78125", "@lon": "-122.38836"}, {"@lat": "37.78089", "@lon": "-122.38849"}, {"@lat": "37.7804", "@lon": "-122.38889"}, {"@lat": "37.77972", "@lon": "-122.38987"}, {"@lat": "37.7762699", "@lon": "-122.39417"}]}, {"point": [{"@lat": "37.79313", "@lon": "-122.39643"}, {"@lat": "37.7943799", "@lon": "-122.39482"}, {"@lat": "37.79449", "@lon": "-122.39456"}, {"@lat": "37.79451", "@lon": "-122.39424"}, {"@lat": "37.79445", "@lon": "-122.39391"}, {"@lat": "37.79427", "@lon": "-122.39342"}, {"@lat": "37.79404", "@lon": "-122.39303"}, {"@lat": "37.79263", "@lon": "-122.39139"}, {"@lat": "37.7924", "@lon": "-122.39114"}, {"@lat": "37.7922", "@lon": "-122.39099"}, {"@lat": "37.7913", "@lon": "-122.39054"}, {"@lat": "37.7909", "@lon": "-122.39019"}, {"@lat": "37.79048", "@lon": "-122.38969"}]}, {"point": [{"@lat": "37.7762699", "@lon": "-122.39408"}, {"@lat": "37.77962", "@lon": "-122.38982"}, {"@lat": "37.7804", "@lon": "-122.38889"}, {"@lat": "37.78071", "@lon": "-122.38861"}, {"@lat": "37.7810599", "@lon": "-122.38841"}, {"@lat": "37.78149", "@lon": "-122.38832"}, {"@lat": "37.78463", "@lon": "-122.38798"}, {"@lat": "37.78792", "@lon": "-122.38783"}, {"@lat": "37.78902", "@lon": "-122.38812"}, {"@lat": "37.78931", "@lon": "-122.38827"}, {"@lat": "37.78958", "@lon": "-122.38849"}, {"@lat": "37.79075", "@lon": "-122.38984"}]}, {"point": [{"@lat": "37.79048", "@lon": "-122.38969"}, {"@lat": "37.78958", "@lon": "-122.38849"}, {"@lat": "37.78931", "@lon": "-122.38827"}, {"@lat": "37.78902", "@lon": "-122.38812"}, {"@lat": "37.78792", "@lon": "-122.38783"}, {"@lat": "37.78149", "@lon": "-122.38832"}, {"@lat": "37.78125", "@lon": "-122.38836"}, {"@lat": "37.78089", "@lon": "-122.38849"}, {"@lat": "37.7804", "@lon": "-122.38889"}, {"@lat": "37.77634", "@lon": "-122.39405"}, {"@lat": "37.7762699", "@lon": "-122.39417"}]}]}}}')

    @gen_test
    def test_validate_command_and_increment(self):
        mh = handlers.base.MessageHandler
        res = yield mh.validate_command_and_increment(mh, 'test')
        self.assertDictEqual(handlers.base.query_counter, {'agencyList': 2, 'routeConfig': 1})
        res = yield mh.validate_command_and_increment(mh, 'agencyList')
        self.assertDictEqual(handlers.base.query_counter, {'agencyList': 3, 'routeConfig': 1})

    @gen_test
    def test_cache(self):
        mh = handlers.base.MessageHandler
        self.assertDictEqual(handlers.base.query_cache, {})
        query = yield self.http_client.fetch(self.get_url('/publicJSONFeed?command=agencyList'))
        self.assertIn('command=agencyList', handlers.base.query_cache)

